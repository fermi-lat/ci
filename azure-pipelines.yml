trigger:
  branches:
    include:
    - master
  paths:
    include: 
    - azure_templates/pipeline_template/azure-pipelines.yml
    exclude:
    - jobs/*
    - README.md
    - azure_templates/pipeline_template/README
    - azure_templates/azure-buildrepolinux-template.yml
    - azure_templates/azure-buildrepomacos-template.yml
    - azure_templates/azure-fermitoolsupdate-template.yml
    - azure_templates/azure-testrepolinux-template.yml
    - azure_templates/azure-testrepomacos-template.yml

variables:
- group: DevOps Access Keys

jobs:

#####################
# Propagate Changes #
#####################

  ### Setup Environment ###
- job: setupenvironment
  displayName: 'Setup working environment'
  steps:
  # Manually adding conda to the PATH is a step required by Microsoft
  - bash: echo "##vso[task.prependpath]$CONDA/bin"
    displayName: 'Add conda to PATH'
  - task: CondaEnvironment@0
    inputs:
      environmentName: 'Env'
      packageSpecs: 'python=2.7'
  - bash: |
      conda install --yes --quiet -c conda-forge/label/cf201901 -c fermi fermi-repoman
    displayName: 'Install Repoman'
  - bash: |
      repoman --remote-base https://github.com/fermi-lat checkout --force --develop ScienceTools conda
      rm -rf *
      git clone https://github.com/fermi-lat/ci
      git clone https://github.com/fermi-lat/st_graph
    displayName: 'Clone repositories'
  - bash: |
      git config --global user.email "joseph.a.asercion@nasa.gov"
      git config --global user.name "jasercion"
      git config --global credential.helper store
      echo https://$(Github-Access-Token):x-oauth-basic@github.com>>~/.git-credentials
      for f in *; do
          if [ $f != "ci" ]
          then
            echo "Updating $f..."
            cd $f
            sed -i 's/value:/value: $f' azure-pipelines.yml
            git commit -m "Propagate Azure Pipeline Template Changes" azure-pipelines.yml
            git push
            cd ../
          fi
      done
    displayName: "Updating Templates"